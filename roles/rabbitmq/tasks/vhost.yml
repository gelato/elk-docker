---

  - name: RabbitMQ HA | Create vhost(s)
    command: >-
       rabbitmqadmin -H localhost -P {{ rabbitmq_talking_port }}
       -u {{ item.user }} -p {{ item.password }}
       declare vhost
       name="{{ item.name }}"
       tracing=no
    with_items: "{{ rabbitmq_vhost_definitions }}"
    run_once: true

  - name: RabbitMQ HA | Create vhost permissions(s)
    command: >-
       rabbitmqadmin -H localhost -P {{ rabbitmq_talking_port }}
       -u {{ item.user }} -p {{ item.password }}
       declare permission
       vhost="{{ item.vhost | default('/', false) }}"
       user="{{ item.user }}"
       configure="{{ item.configure_priv | default('.*') }}"
       write={{ item.write_priv | default('.*') }}"
       read="{{ item.read_priv | default('.*') }}"
    with_items: "{{ rabbitmq_users_definitions }}"
